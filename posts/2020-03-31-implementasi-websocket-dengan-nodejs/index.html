<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Implementasi Mudah Websocket dengan Node.js</title>
  <meta name="og:title" content="Implementasi Mudah Websocket dengan Node.js">

  <meta name="description" content="Implementasi Mudah Websocket dengan Node.js">
  <meta name="og:description" content="Implementasi Mudah Websocket dengan Node.js">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="mandaputtra::fullstuck_developer">
  <link rel="shortcut icon" href="https://cdn.glitch.com/238f8585-6bd5-40c4-a0ff-2b87d4acea6c%2Ftil-16.png?v=1561397433743" type="image/x-icon">
  <link rel="icon" href="https://cdn.glitch.com/238f8585-6bd5-40c4-a0ff-2b87d4acea6c%2Ftil-16.png?v=1561397433743" type="image/x-icon">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mukta&display=swap">
  <meta name="twitter:image" content="https://avatars1.githubusercontent.com/u/23342943?s=460&amp;u=3a5d64c4c86dfbe552ed689e2f968105dff2553a&amp;v=4">
  <meta name="twitter:card" content="summary">
  <meta name="og:image:width" content="256">
  <meta name="og:image:height" content="256">
  <meta name="og:image" content="https://avatars1.githubusercontent.com/u/23342943?s=460&amp;u=3a5d64c4c86dfbe552ed689e2f968105dff2553a&amp;v=4">
  <meta name="twitter:image:alt" content="Full stuck developer">
</head>

<body>
  <main>
    <header class="header-wrapper">
      <h1>
        <a href="/">
          (〃￣ω￣〃ゞ
        </a>
      </h1>
      <ul><li>
          <a href="/stuff/">Stuff</a>
        </li><li>
          <a href="/about/">Me</a>
        </li></ul>
    </header>

    <section>
      <div>
        

<article>
  <header>
    
      <p class="date">31 Mar 2020</p>
    
    <h1>Implementasi Mudah Websocket dengan Node.js</h1>
    
      
      
      
    
      
      
      
        <a class="postlist-tag" href="
        /tags/javascript/
      ">javascript</a>
      
    
      
      
      
        <a class="postlist-tag" href="
        /tags/node/
      ">node</a>
      
    
  </header>
  <div>
    <div>
      <p><a href="https://socket.io/">SocketIO</a> selalu jadi pilihan kawula developer kalau mau implementasi WebSocket pada browser, dan yap SocketIO sebenernya cukup cukup aja untuk masalah ini.</p>
<p>Tapi masalahnya satu, SocketIO ini termasuk <em>fosil</em> teknologi. Banyak browser sudah <a href="https://caniuse.com/#feat=websockets">support websocket</a> dan tidak memerlukan teknik <code>long-polling</code> lagi. Library client <a href="https://bundlephobia.com/result?p=socket.io-client@2.3.0">SocketIO pada browser besar</a>, dan banyak major product seperti Trello yag migrasi dari SocketIO ke native WebSocket dikarenakan performanya lebih baik.</p>
<p>Saya tidak akan menjelaskan satu persatu langkah pembuatannya jika tertarik untuk melihat code-nya bisa langsung <a href="https://github.com/mandaputtra/working-example/tree/master/websocket-demo-pollin">cek disini</a></p>
<h2 id="membuat-koneksi-websocket-pada-server">Membuat Koneksi Websocket Pada Server <a class="direct-link" href="#membuat-koneksi-websocket-pada-server">#</a></h2>
<p>Cukup mudah saya disini memakai <a href="https://www.fastify.io/">fastify</a> dan <a href="https://github.com/websockets/ws">ws</a>.</p>
<p>Kita hanya perlu memasukan <em>instance object</em> server pada aplikasi server HTTP kita (fastify)</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> fastify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fastify'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// inisiasi websocket server</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Websocket</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server<span class="token operator">:</span> fastify<span class="token punctuation">.</span>server <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// _server object_ dari fastify</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// ws berisikan _instance object_ tiap tiap client yang terkoneksi</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// mulai server fastify</span></span><br><span class="highlight-line">  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">await</span> fastify<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'berjalan pada port 3000'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span></code></pre>
<p>Jikalau anda menggunakan express bisa lihat contoh <a href="https://github.com/websockets/ws/blob/master/examples/express-session-parse/index.js">disini</a></p>
<h2 id="event-handling">Event Handling <a class="direct-link" href="#event-handling">#</a></h2>
<p>Saat memakai <code>ws</code> banyak orang bingung soal implementasi <em>event</em>-nya bagaimana. Kalau di SocketIO sangat mudah karena kita bisa pakai <code>emit</code> dan <code>on</code> yang sudah disediakan oleh library.</p>
<p>Tenang Node.js punya modul namanya <a href="https://nodejs.org/api/events.html">events</a>, modul tersebut bisa kita gunakan untuk memperhatikan (<em>watch</em>) event yang kita buat pada websocket kita.</p>
<p>Contoh simple penggunaan events.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// inisiasi event emmiter</span></span><br><span class="highlight-line">  <span class="token keyword">class</span> <span class="token class-name">MyEmitter</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> myEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  myEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'an event occurred!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  myEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'event'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// kirim message ke event</span></span></code></pre>
<p>Oke jadi dengan teknik tsb kita bisa refaktor file di awal kita tadi menjadi seperti ini.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> EventEmmiter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">class</span> <span class="token class-name">SocketConnection</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmmiter</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> server <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      </span><br><span class="highlight-line">      <span class="token comment">// inisiasi server websocket </span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token comment">// menerima pesan yang dikirim user.</span></span><br><span class="highlight-line">        ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token comment">// mengirimkan event </span></span><br><span class="highlight-line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'voting'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> voting<span class="token operator">:</span> <span class="token string">'Jokawi'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SocketConnection</span></code></pre>
<p>Untuk menerima pesan voting tsb kita bisa gunakan dalam <code>index.js</code> kita seperti ini:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> fastify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fastify'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> Socket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./socket'</span><span class="token punctuation">)</span> <span class="token comment">// namain aja file tadi socket</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">const</span> room <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server<span class="token operator">:</span> fastify<span class="token punctuation">.</span>server <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// kita bisa mendengarkan event dari sini</span></span><br><span class="highlight-line">  room<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'voting'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token comment">// lakukan sesuatu saat voting</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>Implementasi bisa dilihat <a href="https://github.com/mandaputtra/working-example/blob/master/websocket-demo-pollin/socket.js">disini</a></p>
<h2 id="broadcast">Broadcast <a class="direct-link" href="#broadcast">#</a></h2>
<p>WebSocket Merupakan komunikasi bidireksional (2 arah) dan hanya One to One antara server dan client saja. Jadi Untuk broadcast pesan kesemua orang  / ke salah satu client yang terkoneksi kita harus menyimpan setiap koneksi yang ada.</p>
<p>contoh :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"> <span class="token comment">// this.sockets merupakan object yang kita simpan di server</span></span><br><span class="highlight-line"> <span class="token comment">// yang berisikan setiap user yang terkoneksi</span></span><br><span class="highlight-line"> <span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> msg<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"> <span class="token punctuation">}</span></span></code></pre>
<h2 id="scaling">Scaling <a class="direct-link" href="#scaling">#</a></h2>
<p>Untuk scaling secara horizontal kita bisa menggunakan redis dan sticky session. Anda bisa baca <a href="https://tsh.io/blog/how-to-scale-websocket/">di sini</a> atau bisa juga lihat implementasi dengan docker di <a href="https://www.youtube.com/watch?v=shJo8Wj7jMA">video ini</a>.</p>
<h2 id="routing">Routing <a class="direct-link" href="#routing">#</a></h2>
<p>Jika kita kepingin routing websocket kita bisa juga kita manfaatkan opsi routing pada <code>ws</code>.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> fastify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fastify'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> Websocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">const</span> room1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server<span class="token operator">:</span> fastify<span class="token punctuation">.</span>server<span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/room1'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> room2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server<span class="token operator">:</span> fastify<span class="token punctuation">.</span>server<span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/room2'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>dan nanti di client (browser) kita bisa koneksi seperti ini</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// konek ke room1</span></span><br><span class="highlight-line"><span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3000/room1'</span><span class="token punctuation">)</span> <span class="token comment">// ws: kalau http kalau htpps pakai wss:</span></span><br><span class="highlight-line"><span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3000/room2'</span><span class="token punctuation">)</span> <span class="token comment">// konek ke room 2</span></span></code></pre>
<h2 id="kesimpulan">Kesimpulan <a class="direct-link" href="#kesimpulan">#</a></h2>
<p>Pakai yang kamu nyaman, SocketIO bagus digunakan kalau kamu bikin aplikasi yang tidak terlalu banyak user, masih menargetkan browser lama seperti IE9, dan mencari solusi cepat. Tapi jika ingin memaksimalkan peforma kita bisa memakai library lain seperti <a href="https://github.com/websockets/ws">ws</a>, <a href="https://github.com/uNetworking/uWebSockets.js/blob/master/README.md">uWebsocket.js</a>, atau library lain. Ingat selalu melihat feedback saat ingin menggunkan library yang cukup krusial pada aplikasi kita.</p>
<p>Yuk mari berkarya!</p>
<h2 id="link-referensi">Link Referensi <a class="direct-link" href="#link-referensi">#</a></h2>
<ul>
<li><a href="https://github.com/websockets/ws/blob/master/doc/ws.md">dokumentasi ws</a></li>
<li><a href="https://github.com/mandaputtra/working-example/tree/master/websocket-demo-pollin">aplikasi polling</a></li>
</ul>

    </div>
  </div>
</article>
<p><a href="/">← Home</a></p>

      </div>
    </section>

    <footer class="footer-wrapper">
      <div>
        <ul>
          
            <li>
              <a href="https://github.com/mandaputtra"> Github </a> </li>
          
            <li>
              <a href="mandaputtra"> Twitter </a> </li>
          
        </ul>
      </div>
    </footer>

  </main>
</body>

</html>
