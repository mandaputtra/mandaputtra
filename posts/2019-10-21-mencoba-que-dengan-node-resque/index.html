<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mencoba que dengan node-resque</title>
  <meta name="og:title" content="Mencoba que dengan node-resque">

  <meta name="description" content="Antrian itu que">
  <meta name="og:description" content="Antrian itu que">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="mandaputtra::fullstuck_developer">
  <link rel="shortcut icon" href="https://cdn.glitch.com/238f8585-6bd5-40c4-a0ff-2b87d4acea6c%2Ftil-16.png?v=1561397433743" type="image/x-icon">
  <link rel="icon" href="https://cdn.glitch.com/238f8585-6bd5-40c4-a0ff-2b87d4acea6c%2Ftil-16.png?v=1561397433743" type="image/x-icon">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mukta&display=swap">
  <meta name="twitter:image" content="https://avatars1.githubusercontent.com/u/23342943?s=460&amp;u=3a5d64c4c86dfbe552ed689e2f968105dff2553a&amp;v=4">
  <meta name="twitter:card" content="summary">
  <meta name="og:image:width" content="256">
  <meta name="og:image:height" content="256">
  <meta name="og:image" content="https://avatars1.githubusercontent.com/u/23342943?s=460&amp;u=3a5d64c4c86dfbe552ed689e2f968105dff2553a&amp;v=4">
  <meta name="twitter:image:alt" content="Full stuck developer">
</head>

<body>
  <main>
    <header class="header-wrapper">
      <h1>
        <a href="/">
          (〃￣ω￣〃ゞ
        </a>
      </h1>
      <ul><li>
          <a href="/stuff/">Stuff</a>
        </li><li>
          <a href="/about/">Me</a>
        </li></ul>
    </header>

    <section>
      <div>
        

<article>
  <header>
    
      <p class="date">19 Oct 2019</p>
    
    <h1>Mencoba que dengan node-resque</h1>
    
      
      
      
    
      
      
      
        <a class="postlist-tag" href="
        /tags/javascript/
      ">javascript</a>
      
    
      
      
      
        <a class="postlist-tag" href="
        /tags/node/
      ">node</a>
      
    
  </header>
  <div>
    <div>
      <p>Hi, kali ini saya akan membahas bagaimana cara kita memanfaatkan fitur <em>background jobs</em> atau <em>queue</em> (antrian) yang bakalan sering kita gunakan.</p>
<h2 id="use-case!">Use Case! <a class="direct-link" href="#use-case!">#</a></h2>
<p>Queue biasanya digunakan untuk memproses sesuatu yang sekiranya dapat dilakukan di belakang layar tanpa adanya interferensi dari user. Seperti mengirimkan email, video encoding, image processing dan berbagai hal lainnya. Salah satu pengalaman saya pribadi, hal ini sangat berguna saat kita ingin mem-<em>blast</em> ribuan email (atau hanya kirim satu email) atau hanya sekedar video encoding dengan <em>ffmpg</em>.</p>
<p>Jika kita menggunakan third-party service untuk pengirimen email/sms sangat disarankan untuk menggunkan <em>queue</em> dikarenkan service tersebut bisa saja kapan kapan down dan failure, ini dapat diatasi baik oleh <em>queue</em>. Setiap proses pada <em>queue</em> seperti sebuah log history, jadi kita bisa tau mana yang gagal dan mungkin dapat dilakukan <em>retry</em> atau hal lain.</p>
<p>Pengiriman email/sms tanpa menggunkan background jobs bisa saja mem-block <em>main-thread</em> pada aplikasi kita, terutama jika kita menggunakan node.js dimana kita harus mempertimbangkan apakah code ini benar benar memblock <em>main-thread</em> atau tidak. Untuk pengecekannya kita bisa gunakan profiling atau contoh simpel code berikut yang dapat memblock <em>main-thread</em> di aplikasi kita :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/file.md'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// blocks here until file is read</span></span></code></pre>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token comment">//  non blocking</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'/file.md'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Sepertinya akan lebih indah jika artikel selanjutnya membahas tentang <code>blocking</code> dan <code>non-blocking</code> code, I/O dan mungkin sedikit profiling 😄.</p>
<h2 id="lest-get-to-the-code...">Lest get to the code... <a class="direct-link" href="#lest-get-to-the-code...">#</a></h2>
<p>Ini hanya <em>que</em> (lest just call it <em>que</em> from now on...) simpel tidak ada multiworker dan sebagainya, but <em>at least</em> setidaknya meng-cover sedikit tentang bagaimana <em>que</em> itu sendiri bekerja.</p>
<p><em>Que</em> biasanya menggunakan algoritma FIFO (First In First Out) pada kali ini kita akan membuat kalkulator sederhana yg dimana nantinya proses kalkulasi akan dilakukan di <em>que</em>. Mari kita buat aplikasi kalkulaktor terminal kita yang simpel ini.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token comment">// calculator.js</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> vorpal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vorpal'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ioredis'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> pub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">//  subscribe to jobs</span></span><br><span class="highlight-line">  redis<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'jobs'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  vorpal<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  vorpal</span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'calc [numbers...]'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token comment">// convert array to strings</span></span><br><span class="highlight-line">      <span class="token keyword">let</span> str <span class="token operator">=</span> args<span class="token punctuation">.</span>numbers<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      pub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'jobs'</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token comment">// prompt again</span></span><br><span class="highlight-line">      <span class="token comment">// this is why I use the lib no need to call</span></span><br><span class="highlight-line">      <span class="token comment">// tailed prompt in node.js core</span></span><br><span class="highlight-line">      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>Seperti biasa dengan kekuatan komunitas dan NPM cukup seperti itu saja sudah jadi. Sebelumnya jika ingin membuat dengan pure nodejs tanpa bantuan <code>vorpal</code>, kita bisa gunakan <code>prompt</code> module dari node.js core.</p>
<p>Kali ini kita memerlukan redis untuk komunikasi (<em>pub/sub</em>) antar node (kalkulator dan que-jobs) jadi pastikan untuk setup redis di mesin yang kita gunakan. Ada beberapa jenis <em>que</em> biasanya kalau <em>que</em> itu tergolong simple dan tidak berat proses <em>que</em> sendiri tidak dipisahkandengan aplikasi atau berjalan satu <em>instance</em>. Pada kali ini kita akan membuat <em>que</em> yang berkomunikasi lewat <em>memcached</em> (Redis) atau bisa kita pisahkan server aplikasi dengan background-jobs.</p>
<p>Pada kali ini kita akan gunakan <code>node-resque</code> sebuah library que yang menurut saya mempunyai interface yang simple dan setidaknya memiliki fitur sceduler dan lain lain.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token comment">// que.js</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> NodeResque <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-resque'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ioredis'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> pub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> math <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mathjs'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">// subschannel in redis</span></span><br><span class="highlight-line">  redis<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'jobs'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// connect to redis</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> connectionDetails <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    pkg<span class="token operator">:</span> <span class="token string">'ioredis'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    password<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    port<span class="token operator">:</span> <span class="token number">6379</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    database<span class="token operator">:</span> <span class="token number">0</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// define a jobs</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> jobs <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token string">'calc'</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function-variable function">perform</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// initialize worker</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeResque<span class="token punctuation">.</span>Worker</span><span class="token punctuation">(</span><span class="token punctuation">{</span> connection<span class="token operator">:</span> connectionDetails<span class="token punctuation">,</span> queues<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'number'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> jobs<span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> worker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker started'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker ended'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'poll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">queue</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker polling </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>queue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ping'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker check in @ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'job'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> job</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">working job </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>queue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">,</span> job<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">job success </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>queue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> >> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'pause'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker paused'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeResque<span class="token punctuation">.</span>Queue</span><span class="token punctuation">(</span><span class="token punctuation">{</span> connection<span class="token operator">:</span> connectionDetails <span class="token punctuation">}</span><span class="token punctuation">,</span> jobs<span class="token punctuation">)</span></span><br><span class="highlight-line">  queue<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  queue<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    redis<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">channel<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'calc'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>Thats it! jalankan di dua terminal, satu untuk kalkulator dan satunya untuk background jobs/<em>que</em> kita. untuk mengunakan kalkulator kita hanya perlu mengetikan <code>calc 12 + 4 * 10 / 2</code>. Ingat sebelum memasukan angka kita harus panggil <code>calc</code> karena kita sudah mendefinisaknnya sebagai command pada aplikasi kalkulator terminal kita <code>.command('calc [numbers...]')</code>.</p>
<h2 id="lest-breaks-it-down!">Lest breaks it down! <a class="direct-link" href="#lest-breaks-it-down!">#</a></h2>
<p>Kedua aplikasi yang kita buat tersebut sama sama berkomunikasi lewat Redis dengan cara <em>pub/sub</em> <code>redis.subscribe('jobs')</code> untuk saling bertukar data. Ini adalah fitur yang sering digunakan di Redis. Kalkulator mengirim message lewat redis melalui <em>pub</em> <code>pub.publish('jobs', str)</code>.</p>
<p>Sekarang untuk job handling <code>node-resque</code> mengunkaan yang namanya <code>worker</code> dimana harus kita panggil dengan :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeResque<span class="token punctuation">.</span>Worker</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">    connection<span class="token operator">:</span> connectionDetails<span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token comment">// queue names</span></span><br><span class="highlight-line">    queues<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'number'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token comment">// jobs</span></span><br><span class="highlight-line">    jobs</span><br><span class="highlight-line">  <span class="token punctuation">)</span></span><br><span class="highlight-line">  worker<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> worker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></span></code></pre>
<p>worker sendiri berkerja untuk mengecek apakah ada <em>jobs/que</em> yang masih ketinggal atau tidak, jika ada maka akan di proses. Kadang kita juga ingin mematikan proses worker di kondisi tertentu. Misal saat kita menghentikan server yang bertugas sebagai worker, kita bisa saja menggunakan <code>process</code> module dari node.js, seperti <code>SIGNINT</code> atau <code>SIGTERM</code>, :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Clearing Que'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">await</span> worker<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>Sebelum kita konek dengan worker biasanya kita definisikan dulu jobs yang akan di proses :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token keyword">const</span> jobs <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token string">'calc'</span><span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token function-variable function">perform</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span></code></pre>
<p>'calc' ini adalah nama dari jobs tersebut. setelah Worker di registrasikan dan jobs sudah ada maka kita daftarkan jobs tersebut ke <em>que</em> menggunakan module <code>NodeResque.Queue</code> :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeResque<span class="token punctuation">.</span>Queue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">  connection<span class="token operator">:</span> connectionDetails</span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">,</span> jobs<span class="token punctuation">)</span></span><br><span class="highlight-line">queue<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">queue<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  redis<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">channel<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// register que to worker</span></span><br><span class="highlight-line">    <span class="token comment">// number ==> que name</span></span><br><span class="highlight-line">    <span class="token comment">// calc ==> jobs name</span></span><br><span class="highlight-line">    <span class="token keyword">await</span> queue<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'calc'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p>Nah komunikasi redis pub/sub biasanya dapat kita peroleh melalui <code>redis.on</code> yang memiliki 2 parameter yaitu <code>channel</code> dan <code>message</code>. Pada contoh ini channel adalah <code>jobs</code> dan cara publish message ke channel dengan <code>pub.publish(namaChannel, message)</code> simple! 😄.</p>
<p>Yak, sepertinya sampai disini dulu pembahasan tentang queue/background-jobs, tidak lupa saya tinggalkan beberapa link penting untuk referensi :</p>
<ul>
<li><a href="https://github.com/taskrabbit/node-resque/tree/master/examples">node-resque example</a></li>
<li><a href="https://youtu.be/NNTsHzER31I">background jobs talks</a></li>
</ul>
<p>Thanks! hit me up on twitter!</p>

    </div>
  </div>
</article>
<p><a href="/">← Home</a></p>

      </div>
    </section>

    <footer class="footer-wrapper">
      <div>
        <ul>
          
            <li>
              <a href="https://github.com/mandaputtra"> Github </a> </li>
          
            <li>
              <a href="mandaputtra"> Twitter </a> </li>
          
        </ul>
      </div>
    </footer>

  </main>
</body>

</html>
