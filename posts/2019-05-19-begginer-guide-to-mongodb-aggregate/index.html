<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beginner Guide on MongoDB .aggregate()</title>
  <meta name="og:title" content="Beginner Guide on MongoDB .aggregate()">

  <meta name="description" content="A story driven approach to mongodb aggregate">
  <meta name="og:description" content="A story driven approach to mongodb aggregate">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
  <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="mandaputtra::fullstuck_developer">
  <link rel="shortcut icon" href="https://cdn.glitch.com/238f8585-6bd5-40c4-a0ff-2b87d4acea6c%2Ftil-16.png?v=1561397433743" type="image/x-icon">
  <link rel="icon" href="https://cdn.glitch.com/238f8585-6bd5-40c4-a0ff-2b87d4acea6c%2Ftil-16.png?v=1561397433743" type="image/x-icon">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mukta&display=swap">
  <meta name="twitter:image" content="https://avatars1.githubusercontent.com/u/23342943?s=460&amp;u=3a5d64c4c86dfbe552ed689e2f968105dff2553a&amp;v=4">
  <meta name="twitter:card" content="summary">
  <meta name="og:image:width" content="256">
  <meta name="og:image:height" content="256">
  <meta name="og:image" content="https://avatars1.githubusercontent.com/u/23342943?s=460&amp;u=3a5d64c4c86dfbe552ed689e2f968105dff2553a&amp;v=4">
  <meta name="twitter:image:alt" content="Full stuck developer">
</head>

<body>
  <main>
    <header class="header-wrapper">
      <h1>
        <a href="/">
          (〃￣ω￣〃ゞ
        </a>
      </h1>
      <ul><li>
          <a href="/stuff/">Stuff</a>
        </li><li>
          <a href="/about/">Me</a>
        </li></ul>
    </header>

    <section>
      <div>
        

<article>
  <header>
    
      <p class="date">19 May 2019</p>
    
    <h1>Beginner Guide on MongoDB .aggregate()</h1>
    
      
      
      
    
      
      
      
        <a class="postlist-tag" href="
        /tags/database/
      ">database</a>
      
    
      
      
      
        <a class="postlist-tag" href="
        /tags/mongodb/
      ">mongodb</a>
      
    
  </header>
  <div>
    <div>
      <p>This article was my journey on NoSQL database lately this year, so this was from beginner to beginner guide.</p>
<p>MongoDB or NoSQL had been trending, but I still love SQL databases for some reason. However, MongoDB had a great Query Syntax (Despite on performance, etc.) that I admit I falling in love with that. I've been work with MongoDB quite sometimes now, and I want to share some tips on using aggregate! The powerful feature in MongoDB.</p>
<p>Oh yeah, you will be quite confused with the syntax, it looks like this :</p>
<pre class="language-text"><code class="language-text"><span class="highlight-line">   </span><br><span class="highlight-line">  .aggregate([{{{{{{{{ }}}}}}}}}]) // I love aggregate, better use your space and get ready"</span><br><span class="highlight-line">  </span></code></pre>
<p>We will learn how to use <code>$facet</code>, <code>$match</code>, <code>$unwind</code>, <code>$project</code>, and <code>$group</code>. Lest provide some data here first :</p>
<pre class="language-json"><code class="language-json"><span class="highlight-line">  </span><br><span class="highlight-line">  <span class="token comment">// Just a simple chat schema here for a real-world example</span></span><br><span class="highlight-line">  <span class="token comment">// RoomID for chat room since it chatting room</span></span><br><span class="highlight-line">  <span class="token comment">// Clients contains all clients on a room ~</span></span><br><span class="highlight-line">  <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">"_id"</span> <span class="token operator">:</span> ObjectId(<span class="token string">"5d1449db6f934a2926c175d1"</span>)<span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"clients"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">          <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          <span class="token string">"sillybilly@mail.com"</span></span><br><span class="highlight-line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"roomId"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"message"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">          <span class="token punctuation">{</span></span><br><span class="highlight-line">              <span class="token property">"time"</span> <span class="token operator">:</span> ISODate(<span class="token string">"2019-06-27T04:44:49.528Z"</span>)<span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"SEND"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"Hello!"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"sender"</span> <span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"receiver"</span> <span class="token operator">:</span> <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"_id"</span> <span class="token operator">:</span> ObjectId(<span class="token string">"5d1449db6f934a2926c175d2"</span>)</span><br><span class="highlight-line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          <span class="token punctuation">{</span></span><br><span class="highlight-line">              <span class="token property">"time"</span> <span class="token operator">:</span> ISODate(<span class="token string">"2019-06-27T04:54:49.528Z"</span>)<span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"status"</span> <span class="token operator">:</span> <span class="token string">"READ"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"Hello Wow Are You?"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"sender"</span> <span class="token operator">:</span> <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"receiver"</span> <span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token property">"_id"</span> <span class="token operator">:</span> ObjectId(<span class="token string">"5d1449ff6f934a2926c175d3"</span>)</span><br><span class="highlight-line">          <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token property">"__v"</span> <span class="token operator">:</span> <span class="token number">0</span></span><br><span class="highlight-line">    ....</span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line">  </span></code></pre>
<h3 id="1st-case-%3A-get-all-message-from-one-user-and-return-his-last-message">1st case : get all message from one user and return his last message <a class="direct-link" href="#1st-case-%3A-get-all-message-from-one-user-and-return-his-last-message">#</a></h3>
<p>Okay in order to do this you could use <code>$match: { clients: &quot;sillybilly@mail.com&quot; }</code> but how to display the last message only, you could use <code>$project</code></p>
<p>In here project only takes what your requested field are, working with aggregate it is like working with <em>stream</em> or <em>pipeline</em>, you should care for every step of it.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  </span><br><span class="highlight-line"></span><br><span class="highlight-line">  db<span class="token punctuation">.</span>chat<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span> $project<span class="token operator">:</span> <span class="token punctuation">{</span> _id<span class="token operator">:</span> <span class="token string">"$roomId"</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token punctuation">{</span> $slice<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"$message"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// result</span></span><br><span class="highlight-line">  <span class="token punctuation">[</span><span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token string">"_id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"message"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">          <span class="token punctuation">{</span></span><br><span class="highlight-line">              <span class="token string">"time"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2019-06-27T04:54:49.528Z"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"status"</span> <span class="token operator">:</span> <span class="token string">"SEND"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"text"</span> <span class="token operator">:</span> <span class="token string">"Hello!"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"sender"</span> <span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"receiver"</span> <span class="token operator">:</span> <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"_id"</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"5d1449ff6f934a2926c175d3"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span> more other result <span class="token punctuation">]</span></span><br><span class="highlight-line">  </span><br><span class="highlight-line">  </span><br><span class="highlight-line"></span></code></pre>
<p>so <code>$project</code> takes field or result on previous result and project it, you can get the previous value of result by using &quot;$&quot; as long it matches the resulted field's.</p>
<p>&quot;Ewww but how come that data are okay? you only had one message, why do you need an array? I don't need that! and why I should go to the <code>message</code> field takes array [0] and get sender&quot; - a wholesome frontend developer.</p>
<h3 id="2nd-case%3A-get-what-that-frontend-developer-wants">2nd case: get what that frontend developer wants <a class="direct-link" href="#2nd-case%3A-get-what-that-frontend-developer-wants">#</a></h3>
<p>Assume that you just select sillybilly as the sender, the one that uses your application, and other users that on <strong>clients array</strong> are other. <code>$unwind</code> to the rescue.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"></span><br><span class="highlight-line">  db<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">'chats'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $unwind<span class="token operator">:</span> <span class="token string">"$clients"</span> <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span></code></pre>
<p>the result of that queries will give you deconstructed array element of matchning documents.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">[</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token punctuation">[</span>bar<span class="token punctuation">,</span> baz<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token comment">// not using unwind</span></span><br><span class="highlight-line">  <span class="token punctuation">[</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> bar <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>foo<span class="token operator">:</span> baz<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token comment">// using unwind $foo</span></span><br><span class="highlight-line">  <span class="token comment">// get that? so now every documents are decoupled</span></span><br><span class="highlight-line"></span></code></pre>
<p>Okay then we can now get the receiver name :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"></span><br><span class="highlight-line">  db<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">'chats'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $unwind<span class="token operator">:</span> <span class="token string">"$clients"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token punctuation">{</span> $ne<span class="token operator">:</span> <span class="token string">'sillybilly@mail.com'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $project<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        _id<span class="token operator">:</span> <span class="token string">"$roomId"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        receiver<span class="token operator">:</span> <span class="token string">"$clients"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        message<span class="token operator">:</span> <span class="token punctuation">{</span> $slice<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"$message"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// result</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token punctuation">[</span><span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token string">"_id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"receiver"</span> <span class="token operator">:</span> <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"message"</span> <span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">          <span class="token punctuation">{</span></span><br><span class="highlight-line">              <span class="token string">"time"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2019-06-27T04:54:49.528Z"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"status"</span> <span class="token operator">:</span> <span class="token string">"SEND"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"text"</span> <span class="token operator">:</span> <span class="token string">"Hello!"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"sender"</span> <span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"reciever"</span> <span class="token operator">:</span> <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token string">"_id"</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"5d1449ff6f934a2926c175d3"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">          <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span> <span class="token operator">...</span> another result<span class="token punctuation">]</span></span><br><span class="highlight-line"></span></code></pre>
<p>Okay nice now send a message to the frontend developer again. But hold on you see the design again it got unread message badge... you should count it. Hmmm. You sit down again and thingking..</p>
<h3 id="3rd-case%3A-count-unread-message-inside-an-array-of-messages-object">3rd case: count unread message inside an array of messages object <a class="direct-link" href="#3rd-case%3A-count-unread-message-inside-an-array-of-messages-object">#</a></h3>
<p>Do you feel it the syntax of already? :V</p>
<p>You already <code>$unwind</code> the clients, should you <code>$unwind</code> again the messages? Yes. It is like working with the stream so you should follow the pattern you create.</p>
<p>Since using <code>$sum</code> in <code>$project</code> requires a lot of <code>$cond</code> you can simplify your query using <code>$group</code>. <code>$group</code> had a lot of <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/#accumulator-operator">accumulator</a> operator that can be useful, for detecting the <code>$last</code> / <code>$first</code> element.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">  <span class="token comment">//  unwind it again</span></span><br><span class="highlight-line">  db<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">'chats'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $unwind<span class="token operator">:</span> <span class="token string">"$clients"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token punctuation">{</span> $ne<span class="token operator">:</span> <span class="token string">'sillybilly@mail.com'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $unwind<span class="token operator">:</span> <span class="token string">"$message"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// messages decoupled her</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token string">"$message.status"</span><span class="token operator">:</span> <span class="token string">'SEND'</span> <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $group<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        _id<span class="token operator">:</span> <span class="token string">'$_id'</span><span class="token punctuation">,</span> <span class="token comment">// we group it by _id</span></span><br><span class="highlight-line">        roomId<span class="token operator">:</span> <span class="token punctuation">{</span> $first<span class="token operator">:</span> <span class="token string">'$roomId'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// accumulator must be used otherwise error will thrown</span></span><br><span class="highlight-line">        receiver<span class="token operator">:</span> <span class="token punctuation">{</span> $first<span class="token operator">:</span> <span class="token string">'$clients'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        unread<span class="token operator">:</span> <span class="token punctuation">{</span> $sum<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        message<span class="token operator">:</span> <span class="token punctuation">{</span> $last<span class="token operator">:</span> <span class="token string">'$message.text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        time<span class="token operator">:</span> <span class="token punctuation">{</span> $last<span class="token operator">:</span> <span class="token string">'$message.time'</span> <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// result</span></span><br><span class="highlight-line">  <span class="token punctuation">[</span><span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token string">"_id"</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"5d1449ff6f934a2926c175d3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"receiver"</span> <span class="token operator">:</span> <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"unread"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"message"</span> <span class="token operator">:</span> <span class="token string">"Hello!"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"time"</span><span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2019-06-27T04:54:49.528Z"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token operator">...</span> another result<span class="token punctuation">]</span></span></code></pre>
<blockquote>
<p>I think this query isn't performing well, imagine if you had 1000 messages, you will unwind 1000 message, that can affect performance? Comment below if you know the best way 😁</p>
</blockquote>
<p>So now you got a beautiful response from your database, the only thing you missing from the design UI is pagination!</p>
<h3 id="4th-case-%3A-paginate-.aggregate()-using-%24facet">4th case : paginate .aggregate() using $facet <a class="direct-link" href="#4th-case-%3A-paginate-.aggregate()-using-%24facet">#</a></h3>
<p>The docs about <code>$facet</code> say something like this: &quot;Processes multiple aggregation pipelines within a single stage on the same set of input documents&quot;.</p>
<p>That means that we can use aggregation inside <code>$facet</code> like <code>$unwind</code>. But we don't need to unwind again, to do your pagination via <code>$facet</code> you could just use this query :</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"></span><br><span class="highlight-line">  db<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token string">'chats'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token string">"sillybilly@mail.com"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $unwind<span class="token operator">:</span> <span class="token string">"$clients"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token punctuation">{</span> clients<span class="token operator">:</span> <span class="token punctuation">{</span> $ne<span class="token operator">:</span> <span class="token string">'sillybilly@mail.com'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $unwind<span class="token operator">:</span> <span class="token string">"$message"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $match<span class="token operator">:</span> <span class="token string">"$message.status"</span><span class="token operator">:</span> <span class="token string">'SEND'</span> <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span> $group<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">          _id<span class="token operator">:</span> <span class="token string">'$_id'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          roomId<span class="token operator">:</span> <span class="token punctuation">{</span> $first<span class="token operator">:</span> <span class="token string">'$roomId'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          receiver<span class="token operator">:</span> <span class="token punctuation">{</span> $first<span class="token operator">:</span> <span class="token string">'$clients'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          unread<span class="token operator">:</span> <span class="token punctuation">{</span> $sum<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          message<span class="token operator">:</span> <span class="token punctuation">{</span> $last<span class="token operator">:</span> <span class="token string">'$message.text'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          time<span class="token operator">:</span> <span class="token punctuation">{</span> $last<span class="token operator">:</span> <span class="token string">'$message.time'</span> <span class="token punctuation">}</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token punctuation">{</span></span><br><span class="highlight-line">        $facet<span class="token operator">:</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            metadata<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> $count<span class="token operator">:</span> <span class="token string">'total'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> $addFields<span class="token operator">:</span> <span class="token punctuation">{</span> page<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">            data<span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">              <span class="token punctuation">{</span> $skip<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">              <span class="token punctuation">{</span> $limit<span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">}</span></span><br><span class="highlight-line">            <span class="token punctuation">]</span></span><br><span class="highlight-line">          <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    <span class="token punctuation">]</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">// result: now you got a paginated response</span></span><br><span class="highlight-line">  <span class="token punctuation">[</span><span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token string">"metadata"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> $count<span class="token operator">:</span> <span class="token string">'total'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> page<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      <span class="token string">"data"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">        <span class="token punctuation">{</span></span><br><span class="highlight-line">          <span class="token string">"_id"</span> <span class="token operator">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">"5d1449ff6f934a2926c175d3"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          <span class="token string">"receiver"</span> <span class="token operator">:</span> <span class="token string">"rooberduck@mail.com"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          <span class="token string">"unread"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          <span class="token string">"message"</span> <span class="token operator">:</span> <span class="token string">"Hello!"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">          <span class="token string">"time"</span><span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2019-06-27T04:54:49.528Z"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">      <span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token operator">...</span> another result<span class="token punctuation">]</span></span><br><span class="highlight-line"></span></code></pre>
<p>That's it you got your beautiful response API, now you come the frontend dev and say, you got it done, and the he/she accept your API response.</p>
<p>See you next post, and had an awesome day :)</p>
<p>Feedback always welcome.</p>

    </div>
  </div>
</article>
<p><a href="/">← Home</a></p>

      </div>
    </section>

    <footer class="footer-wrapper">
      <div>
        <ul>
          
            <li>
              <a href="https://github.com/mandaputtra"> Github </a> </li>
          
            <li>
              <a href="mandaputtra"> Twitter </a> </li>
          
        </ul>
      </div>
    </footer>

  </main>
</body>

</html>
